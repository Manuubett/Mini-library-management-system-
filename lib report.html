<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CarenChebet Library - Reports & Analytics</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #4e73df;
      --primary-dark: #2e59d9;
      --secondary: #6c757d;
      --success: #1cc88a;
      --info: #36b9cc;
      --warning: #f6c23e;
      --danger: #e74a3b;
      --light: #f8f9fc;
      --dark: #5a5c69;
      --border: #e3e6f0;
      --card-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      --hover-shadow: 0 0.5rem 2rem 0 rgba(58, 59, 69, 0.2);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fc;
      color: #5a5c69;
      line-height: 1.6;
    }
    
    /* Header Styles */
    header {
      background: white;
      box-shadow: var(--card-shadow);
      padding: 1rem 0;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--primary);
    }
    
    /* Navigation Styles */
    nav {
      display: flex;
      gap: 20px;
    }
    
    nav a {
      text-decoration: none;
      color: var(--dark);
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    
    nav a:hover {
      background: var(--light);
      color: var(--primary);
    }
    
    nav a.active {
      background: var(--primary);
      color: white;
    }
    
    /* Main Content Styles */
    main {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }
    
    .page-title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 25px;
      color: var(--dark);
    }
    
    /* Summary Cards */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .summary-card {
      background: white;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      padding: 25px;
      display: flex;
      align-items: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .summary-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--hover-shadow);
    }
    
    .card-icon {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 20px;
      font-size: 1.8rem;
    }
    
    .books-icon {
      background: var(--primary);
      color: white;
    }
    
    .members-icon {
      background: var(--success);
      color: white;
    }
    
    .issues-icon {
      background: var(--warning);
      color: white;
    }
    
    .card-content {
      flex: 1;
    }
    
    .card-title {
      font-size: 0.9rem;
      color: var(--secondary);
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    
    .card-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--dark);
    }
    
    /* Charts Section */
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .chart-card {
      background: white;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      padding: 25px;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .chart-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
    }
    
    /* Data Tables Section */
    .tables-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 25px;
    }
    
    .table-card {
      background: white;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      padding: 25px;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .table-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th,
    .data-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .data-table th {
      background-color: var(--light);
      color: var(--dark);
      font-weight: 700;
    }
    
    .data-table tr:hover {
      background-color: #f8f9fc;
    }
    
    /* Footer */
    footer {
      text-align: center;
      padding: 30px;
      margin-top: 40px;
      color: var(--secondary);
      border-top: 1px solid var(--border);
    }
    
    /* Responsive Design */
    @media (max-width: 1100px) {
      .charts-container,
      .tables-container {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
      }
      
      nav {
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }
      
      .summary-cards {
        grid-template-columns: 1fr;
      }
      
      .chart-container {
        height: 250px;
      }
      
      .summary-card {
        flex-direction: column;
        text-align: center;
      }
      
      .card-icon {
        margin-right: 0;
        margin-bottom: 15px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <i class="fas fa-book-open"></i>
        <span>CarenChebet Library</span>
      </div>
      <nav>
        <a href="index.html"><i class="fas fa-home"></i> Home</a>
        <a href="add book.html"><i class="fas fa-book"></i> Books</a>
        <a href="lib registration.html"><i class="fas fa-users"></i> Members</a>
        <a href="issue 1.html"><i class="fas fa-exchange-alt"></i> Issue & Return</a>
        <a href="report.html" class="active"><i class="fas fa-chart-bar"></i> Reports</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="page-title">
      <i class="fas fa-chart-line"></i>
      <h1>Library Reports & Analytics</h1>
    </div>
    
    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-icon books-icon">
          <i class="fas fa-book"></i>
        </div>
        <div class="card-content">
          <div class="card-title">Total Books</div>
          <div class="card-value" id="totalBooks">0</div>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-icon members-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="card-content">
          <div class="card-title">Total Members</div>
          <div class="card-value" id="totalMembers">0</div>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-icon issues-icon">
          <i class="fas fa-exchange-alt"></i>
        </div>
        <div class="card-content">
          <div class="card-title">Issued Books</div>
          <div class="card-value" id="issuedBooks">0</div>
        </div>
      </div>
    </div>
    
    <!-- Charts Section -->
    <div class="charts-container">
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">
            <i class="fas fa-bookmark"></i>
            Books Availability
          </h2>
        </div>
        <div class="chart-container">
          <canvas id="booksChart"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">
            <i class="fas fa-chart-bar"></i>
            Top Members by Books Issued
          </h2>
        </div>
        <div class="chart-container">
          <canvas id="issuesChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Data Tables Section -->
    <div class="tables-container">
      <div class="table-card">
        <div class="table-header">
          <h2 class="table-title">
            <i class="fas fa-list"></i>
            Recently Issued Books
          </h2>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Book Title</th>
              <th>Member</th>
              <th>Issue Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="recentIssues">
            <tr>
              <td colspan="4" style="text-align: center;">Loading data...</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="table-card">
        <div class="table-header">
          <h2 class="table-title">
            <i class="fas fa-exclamation-triangle"></i>
            Overdue Books
          </h2>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Book Title</th>
              <th>Member</th>
              <th>Due Date</th>
              <th>Days Overdue</th>
            </tr>
          </thead>
          <tbody id="overdueBooks">
            <tr>
              <td colspan="4" style="text-align: center;">Loading data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2023 CarenChebet Library Management System. All rights reserved.</p>
  </footer>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getFirestore, collection, getDocs 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAKMv1RIemwkvnBeIL7CriWiL0VprPipoI",
      authDomain: "smart-f77b6.firebaseapp.com",
      projectId: "smart-f77b6",
      storageBucket: "smart-f77b6.appspot.com",
      messagingSenderId: "210530046379",
      appId: "1:210530046379:web:b2ecca8adc946581f842ee",
      measurementId: "G-Y42CQGSQ5S"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const booksCol = collection(db, "books");
    const membersCol = collection(db, "members");
    const issuesCol = collection(db, "issues");

    async function loadReportData() {
      try {
        const booksSnap = await getDocs(booksCol);
        const membersSnap = await getDocs(membersCol);
        const issuesSnap = await getDocs(issuesCol);

        const totalBooks = booksSnap.size;
        const totalMembers = membersSnap.size;
        const issuedBooks = issuesSnap.size;

        document.getElementById("totalBooks").textContent = totalBooks;
        document.getElementById("totalMembers").textContent = totalMembers;
        document.getElementById("issuedBooks").textContent = issuedBooks;

        // --- Chart 1: Books Available vs Issued ---
        let available = 0;
        booksSnap.forEach((doc) => {
          const book = doc.data();
          available += book.availableCopies || 0;
        });
        const issued = totalBooks - available;

        new Chart(document.getElementById("booksChart"), {
          type: "doughnut",
          data: {
            labels: ["Available", "Issued"],
            datasets: [{
              data: [available, issued],
              backgroundColor: ["#1cc88a", "#f6c23e"],
              hoverBackgroundColor: ["#17a673", "#f4b30d"],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  font: {
                    size: 13
                  },
                  padding: 20
                }
              }
            },
            cutout: "70%"
          }
        });

        // --- Chart 2: Issues per Member (Top 5) ---
        const issueCount = {};
        issuesSnap.forEach((doc) => {
          const issue = doc.data();
          issueCount[issue.memberName] = (issueCount[issue.memberName] || 0) + 1;
        });

        const sortedMembers = Object.entries(issueCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
        const memberNames = sortedMembers.map(item => item[0]);
        const issueNumbers = sortedMembers.map(item => item[1]);

        new Chart(document.getElementById("issuesChart"), {
          type: "bar",
          data: {
            labels: memberNames,
            datasets: [{
              label: "Books Issued",
              data: issueNumbers,
              backgroundColor: "#4e73df",
              borderColor: "#2e59d9",
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });

        // --- Recent Issues Table ---
        const recentIssuesTbody = document.getElementById("recentIssues");
        recentIssuesTbody.innerHTML = "";
        
        // Get the 5 most recent issues
        const issuesData = [];
        issuesSnap.forEach(doc => {
          issuesData.push({ id: doc.id, ...doc.data() });
        });
        
        // Sort by date (assuming you have an issueDate field)
        issuesData.sort((a, b) => {
          // This is a simple sort - you might need to adjust based on your date format
          return new Date(b.issueDate) - new Date(a.issueDate);
        }).slice(0, 5).forEach(issue => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${issue.bookTitle || "N/A"}</td>
            <td>${issue.memberName || "N/A"}</td>
            <td>${issue.issueDate || "N/A"}</td>
            <td>${issue.status || "Issued"}</td>
          `;
          recentIssuesTbody.appendChild(row);
        });

        // --- Overdue Books Table ---
        const overdueTbody = document.getElementById("overdueBooks");
        overdueTbody.innerHTML = "";
        
        // This is a placeholder - you'll need to implement actual overdue detection
        // based on your data structure
        const today = new Date();
        const overdueBooks = issuesData.filter(issue => {
          // Simple example - you'll need to adjust this logic
          if (issue.returnDate) {
            const returnDate = new Date(issue.returnDate);
            return returnDate < today && issue.status !== "Returned";
          }
          return false;
        }).slice(0, 5);
        
        if (overdueBooks.length > 0) {
          overdueBooks.forEach(book => {
            const returnDate = new Date(book.returnDate);
            const daysOverdue = Math.floor((today - returnDate) / (1000 * 60 * 60 * 24));
            
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${book.bookTitle || "N/A"}</td>
              <td>${book.memberName || "N/A"}</td>
              <td>${book.returnDate || "N/A"}</td>
              <td>${daysOverdue} days</td>
            `;
            overdueTbody.appendChild(row);
          });
        } else {
          overdueTbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No overdue books found</td></tr>';
        }

      } catch (error) {
        console.error("Error loading report data:", error);
      }
    }

    loadReportData();
  </script>
</body>
</html>
